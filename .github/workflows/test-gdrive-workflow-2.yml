name: Upload APK to Google Drive

on:
  push:
    branches:
      - main

jobs:
  upload-to-drive:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set Version
        run: echo "VERSION=1.0.0" >> $GITHUB_ENV

      - name: Decode and Save Google Credentials
        run: |
          echo "${{ secrets.GDRIVE_CREDENTIALS_BASE64 }}" | base64 --decode > credentials.json

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client google-auth google-auth-httplib2 google-auth-oauthlib

      - name: Upload APK to Google Drive
        env:
          VERSION: ${{ env.VERSION }}
        run: |
          python <<EOF
          import os
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload
          from google.oauth2.service_account import Credentials

          # Hole die Umgebungsvariablen
          version = os.getenv('VERSION')
          file_name = f"my-app-{version}.apk"
          file_path = os.path.join('path/to/your/local/directory', file_name)

          # Google Drive API einrichten
          credentials = Credentials.from_service_account_file('credentials.json')
          service = build('drive', 'v3', credentials=credentials)

          # Datei-Metadaten und Upload
          file_metadata = {'name': file_name}
          media = MediaFileUpload(file_path, mimetype='application/vnd.android.package-archive')
          file = service.files().create(body=file_metadata, media_body=media, fields='id').execute()
          print(f"Datei erfolgreich hochgeladen. File ID: {file.get('id')}")
          EOF
